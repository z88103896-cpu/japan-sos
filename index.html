<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japan Safety SOS Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/10263/10263336.png">
    <meta name="theme-color" content="#d32f2f">
    <style>
        :root { 
            --emergency-red: #ff3b30; 
            --warning-yellow: #ffcc00; 
            --line-green: #34c759; 
            --install-blue: #007aff; 
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body { 
            margin: 0; 
            background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%);
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…Ø·ÙˆØ± ÙˆØ§Ù„Ø£ÙƒØ¨Ø± */
        #installBtn { 
            display: none; 
            width: 100%; 
            padding: 22px 10px; 
            background: var(--install-blue); 
            color: white; 
            border: none; 
            font-weight: 900; 
            font-size: 1.2rem;
            cursor: pointer; 
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            position: sticky; 
            top: 0; 
            z-index: 2000; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø§Ø®ØªÙØ§Ø¡ */
            letter-spacing: 1px;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .status-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 15px 0;
            position: relative;
            z-index: 1000;
        }

        .status-bar { 
            font-size: 0.9rem; padding: 10px 25px; display: inline-flex; 
            align-items: center; gap: 8px; backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px); background: var(--glass-bg);
            border: 1px solid var(--glass-border); border-radius: 50px;
        }
        #status-icon { display: none; color: var(--line-green); font-weight: bold; }

        .app-container { width: 92%; max-width: 420px; text-align: center; padding-bottom: 50px; }

        .emergency-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; 
        }
        .call-card { 
            padding: 20px 10px; text-decoration: none; color: white; 
            border-radius: 20px; border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; gap: 5px; background: var(--glass-bg);
        }
        .call-card.police { background: rgba(0, 122, 255, 0.15); }
        .call-card.ambulance { background: rgba(255, 59, 48, 0.15); }
        .call-card b { font-size: 1.6rem; }

        .main-sos-section { margin: 30px 0; }
        .sos-btn { 
            width: 180px; height: 180px; border-radius: 50%; 
            background: radial-gradient(circle, #ff5e57, #d32f2f); 
            color: white; font-size: 2.2rem; font-weight: 900; 
            border: 8px solid rgba(255, 255, 255, 0.15); 
            cursor: pointer; box-shadow: 0 0 50px rgba(211, 47, 47, 0.6);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; transition: 0.2s;
        }
        .sos-btn.active { background: white; color: var(--emergency-red); animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.08); } }

        .secondary-actions { display: flex; flex-direction: column; gap: 12px; }
        .glass-action { 
            padding: 18px; border: 1px solid var(--glass-border); 
            border-radius: 16px; font-size: 1.1rem; font-weight: bold; 
            cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 12px; background: var(--glass-bg); color: white;
        }
        .voice-btn { color: var(--warning-yellow); }
        .line-btn { color: var(--line-green); }

        .location-panel { 
            margin-top: 25px; padding: 15px; font-size: 0.85rem; color: #bbb;
            border-radius: 20px; border: 1px solid var(--glass-border); background: var(--glass-bg);
        }

        /* Modals Styling */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.95); z-index: 5000; 
            display: flex; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(10px);
        }
        .modal-body { 
            width: 100%; max-width: 450px; background: #1c1c1e; 
            padding: 25px; border-radius: 24px; max-height: 85vh; overflow-y: auto;
            text-align: left; border: 1px solid #333;
        }
        .modal-body h2 { color: var(--emergency-red); text-align: center; margin-bottom: 20px; font-size: 1.3rem; }
        .terms-box { margin-bottom: 15px; }
        .terms-box h3 { font-size: 0.95rem; color: var(--warning-yellow); margin-bottom: 8px; border-left: 4px solid; padding-left: 10px; }
        .terms-box p { font-size: 0.85rem; color: #ccc; line-height: 1.5; margin: 0; }
        
        .check-item { 
            display: flex; align-items: center; gap: 15px; margin-top: 10px; 
            cursor: pointer; padding: 15px; border-radius: 12px; 
            background: rgba(255,255,255,0.05); transition: background 0.2s;
        }
        .check-item:active { background: rgba(255,255,255,0.1); }
        .check-item input { width: 24px; height: 24px; flex-shrink: 0; pointer-events: none; }
        .check-item label { font-size: 0.9rem; color: white; font-weight: bold; pointer-events: none; line-height: 1.4; }

        .agree-btn { 
            width: 100%; padding: 20px; border: none; border-radius: 15px; 
            font-weight: bold; font-size: 1.1rem; margin-top: 15px; cursor: pointer;
            background: #444; color: #888; transition: 0.3s;
        }
        .agree-btn.active { background: var(--emergency-red); color: white; box-shadow: 0 4px 20px rgba(255, 59, 48, 0.4); }

        .footer-nav { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 0.8rem; color: #666; }
        .footer-link { text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <button id="installBtn">ğŸ“² ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)</button>

    <div class="status-container">
        <div class="status-bar">
            <span id="status-text">èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§ãŠå¾…ã¡ãã ã•ã„...</span>
            <span id="status-icon">âœ… æº–å‚™å®Œäº†</span>
        </div>
    </div>

    <div class="app-container">
        <h1 style="font-size: 1.2rem; font-weight: 300; color: #eee; margin-bottom: 20px;">Japan Safety SOS Pro</h1>

        <div class="emergency-grid">
            <a href="tel:110" class="call-card police">
                <span>è­¦å¯Ÿã¸ã®é€šå ±</span>
                <b>110</b>
            </a>
            <a href="tel:119" class="call-card ambulance">
                <span>æ•‘æ€¥ãƒ»æ¶ˆé˜²</span>
                <b>119</b>
            </a>
        </div>

        <div class="main-sos-section">
            <button id="sosBtn" class="sos-btn">è­¦å ±</button>
        </div>

        <div class="secondary-actions">
            <button id="voiceBtn" class="glass-action voice-btn">ğŸ“¢ åŠ©ã‘ã¦ãã ã•ã„</button>
            <button id="lineBtn" class="glass-action line-btn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" width="22" alt="LINE">
                LINEã§ç¾åœ¨åœ°ã‚’é€ä¿¡
            </button>
        </div>

        <div id="locationDisplay" class="location-panel">
            <span>ğŸ“ GPSä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</span>
        </div>

        <div class="footer-nav">
            <span class="footer-link" onclick="document.getElementById('consentModal').style.display='flex'">åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …</span>
            <span class="footer-link" onclick="document.getElementById('safetyGuideModal').style.display='flex'">å®‰å…¨ãƒ»é¿é›£ã‚¬ã‚¤ãƒ‰</span>
            <span class="footer-link" onclick="document.getElementById('gpsGuideModal').style.display='flex'">GPSã‚’æœ‰åŠ¹ã«ã™ã‚‹æ–¹æ³•</span>
            <span style="font-size: 0.7rem; color: #444; margin-top: 10px;">â€»å€‹äººã«ã‚ˆã‚‹æä¾›ã§ã‚ã‚Šã€ã„ã‹ãªã‚‹å…¬çš„æ©Ÿé–¢ã¨ã‚‚ææºã—ã¦ã„ã¾ã›ã‚“ã€‚</span>
        </div>
    </div>

    <!-- åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-body">
            <h2>åˆ©ç”¨è¦ç´„ãƒ»é‡è¦äº‹é …</h2>
            
            <div class="terms-box">
                <h3>1. GPSã¨é€šä¿¡ã®å¿…è¦æ¡ä»¶</h3>
                <p>æ­£ç¢ºãªåŠ©ã‘ã‚’å‘¼ã¶ãŸã‚ã€GPSè¨±å¯ã¨ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…é ˆã§ã™ã€‚åœ°ä¸‹ã€åœå¤–ã€å»ºç‰©å†…ã§ã¯ä½ç½®æƒ…å ±ãŒé€ä¿¡ã•ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã¯è£œåŠ©ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€å®‰å…¨ã‚’å®Œå…¨ã«ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <div class="check-item" onclick="toggleCheck('c1')">
                    <input type="checkbox" class="term-check" id="c1">
                    <label>GPSã¨ãƒãƒƒãƒˆç’°å¢ƒã®åˆ¶é™ã«åŒæ„ã—ã¾ã™ã€‚</label>
                </div>
            </div>

            <div class="terms-box">
                <h3>2. LINEé€ä¿¡ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</h3>
                <p>LINEé€ä¿¡æ™‚ã¯ç¾åœ¨åœ°URLãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚æ•‘åŠ©è€…ãŒã‚ãªãŸã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®é‡è¦ãªæƒ…å ±ã§ã™ã€‚æµå‡ºã‚’é˜²ããŸã‚ã€å¿…ãšå®¶æ—ãªã©ä¿¡é ¼ã§ãã‚‹äººã‚’é€ä¿¡å…ˆã«é¸ã‚“ã§ãã ã•ã„ã€‚èª¤é€ä¿¡ã®è²¬ä»»ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¸°å±ã—ã¾ã™ã€‚</p>
                <div class="check-item" onclick="toggleCheck('c2')">
                    <input type="checkbox" class="term-check" id="c2">
                    <label>é€ä¿¡å…ˆã‚’ä¿¡é ¼ã§ãã‚‹äººã«é™å®šã™ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™ã€‚</label>
                </div>
            </div>

            <div class="terms-box">
                <h3>3. è­¦å‘ŠéŸ³ã¨éŸ³é‡è¨­å®š</h3>
                <p>Bluetoothã‚¤ãƒ¤ãƒ›ãƒ³ã‚„ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ã€å‘¨å›²ã«è­¦å‘ŠéŸ³ãŒèã“ãˆã¾ã›ã‚“ã€‚SOSä½¿ç”¨æ™‚ã¯å¿…ãšéŸ³é‡ã‚’æœ€å¤§ã«ã—ã€å‘¨å›²ã«èã“ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ã„ãŸãšã‚‰ç›®çš„ã®é³´å‹•ã¯å³ç¦ã§ã™ã€‚</p>
                <div class="check-item" onclick="toggleCheck('c3')">
                    <input type="checkbox" class="term-check" id="c3">
                    <label>éŸ³é‡è¨­å®šã¨ã‚¤ãƒ¤ãƒ›ãƒ³ä½¿ç”¨æ™‚ã®æ³¨æ„ã‚’ç†è§£ã—ã¾ã—ãŸã€‚</label>
                </div>
            </div>

            <div class="terms-box">
                <h3>4. æ³•çš„è²¬ä»»ã¨æ€§è³ª</h3>
                <p>æœ¬ã‚¢ãƒ—ãƒªã¯å€‹äººã«ã‚ˆã‚‹æ´»å‹•ã§ã‚ã‚Šã€å…¬çš„æ©Ÿé–¢ã®ä»£æ›¿ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è™šå½ã®é€šå ±ã¯æ³•å¾‹ã§ç½°ã›ã‚‰ã‚Œã¾ã™ã€‚18æ­³æœªæº€ã®æ–¹ã¯ä¿è­·è€…ã®æŒ‡å°ã®ã‚‚ã¨ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚å…¨ã¦ã®åˆ©ç”¨ã¯è‡ªå·±è²¬ä»»ã¨ãªã‚Šã¾ã™ã€‚</p>
                <div class="check-item" onclick="toggleCheck('c4')">
                    <input type="checkbox" class="term-check" id="c4">
                    <label>æœ¬ã‚¢ãƒ—ãƒªãŒå€‹äººæä¾›ã®è£œåŠ©ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™ã€‚</label>
                </div>
            </div>

            <button id="agreeBtn" class="agree-btn" disabled>è¦ç´„ã«åŒæ„ã—ã¦é–‹å§‹</button>
        </div>
    </div>

    <!-- å®‰å…¨ãƒ»é¿é›£ã‚¬ã‚¤ãƒ‰ -->
    <div id="safetyGuideModal" class="modal-overlay" style="display:none;">
        <div class="modal-body">
            <h2>å®‰å…¨ãƒ»é¿é›£ã®ãƒ’ãƒ³ãƒˆ</h2>
            <div class="terms-box">
                <h3>ğŸ†˜ ç·Šæ€¥æ™‚ã®è¡Œå‹•ã‚¬ã‚¤ãƒ‰</h3>
                <p>1. <b>å‘¨å›²ã«çŸ¥ã‚‰ã›ã‚‹:</b> ã‚¢ãƒ—ãƒªã®è­¦å‘ŠéŸ³ã ã‘ã§ãªãØŒ å¤§å£°ã§ã€ŒåŠ©ã‘ã¦ãã ã•ã„ï¼ã€ã¨å«ã‚“ã§ãã ã•ã„ã€‚<br><br>
                   2. <b>å…¬å…±ã®å ´ã¸ç§»å‹•:</b> äººæ°—ã®ãªã„å ´æ‰€ã‚’é¿ã‘ØŒ ã§ãã‚‹ã ã‘äººãŒå¤šã„æ˜ã‚‹ã„å…¬å…±ã®å ´æ‰€ã¸ç§»å‹•ã—ã¦ãã ã•ã„ã€‚<br><br>
                   3. <b>å½“å±€ã¸ã®é€£çµ¡:</b> æœ¬ã‚¢ãƒ—ãƒªã¯è£œåŠ©ç”¨ã§ã™ã€‚ç›´ã¡ã«110ç•ªã‚„119ç•ªã¸ç›´æ¥é›»è©±ã—ØŒ å½“å±€ã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚</p>
            </div>
            <button class="agree-btn active" onclick="document.getElementById('safetyGuideModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Ø¯Ù„ÙŠÙ„ ØªÙØ¹ÙŠÙ„ GPS -->
    <div id="gpsGuideModal" class="modal-overlay" style="display:none;">
        <div class="modal-body">
            <h2>GPSã‚’æœ‰åŠ¹ã«ã™ã‚‹æ–¹æ³•</h2>
            <div class="terms-box">
                <h3>ğŸ“± iPhone (iOS)</h3>
                <p>1. [è¨­å®š] > [ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£] > [ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹] ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ã€‚<br>
                   2. ãƒ–ãƒ©ã‚¦ã‚¶ (Safariãªã©) ã®è¨­å®šã§ [ã“ã®ã‚µã‚¤ãƒˆ] ã®ä½ç½®æƒ…å ±ã‚¢ã‚¯ã‚»ã‚¹ã‚’ [è¨±å¯] ã«ã—ã¦ãã ã•ã„ã€‚</p>
                
                <h3>ğŸ¤– Android</h3>
                <p>1. [è¨­å®š] > [ä½ç½®æƒ…å ±] ã‚’ã‚ªãƒ³ã«ã—ã¾ã™ã€‚<br>
                   2. ãƒ–ãƒ©ã‚¦ã‚¶ (Chromeãªã©) ã® [ã‚µã‚¤ãƒˆã®è¨­å®š] ã‹ã‚‰ä½ç½®æƒ…å ±ã®æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
                
                <p style="color:var(--warning-yellow); margin-top:15px; font-weight:bold;">â€»åœ°ä¸‹ã‚„å»ºç‰©ã®ä¸­ã§ã¯GPSãŒå—ä¿¡ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã§ãã‚‹ã ã‘çª“éš›ã‚„å±‹å¤–ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <button class="agree-btn active" onclick="document.getElementById('gpsGuideModal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- LINEé€ä¿¡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal-overlay" style="display:none;">
        <div class="modal-body" style="text-align:center;">
            <h2 style="color:var(--line-green);">LINEé€ä¿¡ã®ç¢ºèª</h2>
            <p style="font-weight:bold; color:white; line-height:1.6;">ä½ç½®æƒ…å ±(GPS)ã¨æ•‘åŠ©è¦è«‹ã‚’é€ä¿¡ã—ã¾ã™ã€‚<br>ä¿¡é ¼ã§ãã‚‹å®¶æ—ã‚„å‹äººãŒå®›å…ˆã§ã‚ã‚‹ã“ã¨ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            <p style="color:var(--warning-yellow); border:1px solid #444; padding:12px; border-radius:12px; font-size:0.85rem;">âš ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæœªæ¥ç¶šæ™‚ã¯é€ä¿¡ã§ãã¾ã›ã‚“ã€‚</p>
            <div style="display:flex; gap:12px; margin-top:25px;">
                <button class="agree-btn active" style="margin:0; background:#333;" onclick="document.getElementById('confirmModal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="agree-btn active" style="margin:0; background:var(--line-green);" onclick="executeLineSend()">OK (é€ä¿¡å…ˆã‚’ç¢ºèªã—ãŸ)</button>
            </div>
        </div>
    </div>

    <script>
        let isPlaying = false, audioCtx, oscillator, sirenInterval, deferredPrompt, userLocation = "";

        function toggleCheck(id) {
            const cb = document.getElementById(id);
            cb.checked = !cb.checked;
            validateChecks();
        }

        function validateChecks() {
            const checks = document.querySelectorAll('.term-check');
            const allChecked = Array.from(checks).every(c => c.checked);
            const btn = document.getElementById('agreeBtn');
            if (allChecked) { btn.classList.add('active'); btn.disabled = false; }
            else { btn.classList.remove('active'); btn.disabled = true; }
        }

        if (localStorage.getItem('appConsent_v10') === 'true') {
            document.getElementById('consentModal').style.display = 'none';
            startTracking();
        }

        document.getElementById('agreeBtn').addEventListener('click', () => {
            localStorage.setItem('appConsent_v10', 'true');
            document.getElementById('consentModal').style.display = 'none';
            startTracking();
        });

        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const { latitude: lat, longitude: lon } = pos.coords;
                    userLocation = `https://www.google.com/maps?q=${lat},${lon}`;
                    document.getElementById('locationDisplay').innerHTML = `ğŸ“ ç¾åœ¨åœ°ã‚’ç‰¹å®šã—ã¾ã—ãŸ<br><span style="color:var(--line-green); font-size:1.1rem; font-weight:bold;">${lat.toFixed(5)}, ${lon.toFixed(5)}</span>`;
                }, (err) => {
                    document.getElementById('locationDisplay').innerHTML = `<span style="color:red; font-weight:bold;">âš ï¸ GPSè¨±å¯ãŒå¿…è¦ã§ã™<br><small onclick="document.getElementById('gpsGuideModal').style.display='flex'" style="text-decoration:underline; cursor:pointer; color:#888;">è¨­å®šæ–¹æ³•ã‚’è¦‹ã‚‹</small></span>`;
                }, { enableHighAccuracy: true });
            }
        }

        document.getElementById('lineBtn').addEventListener('click', () => {
            if (!navigator.onLine) return showMessage("âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœªæ¥ç¶šã§ã™ã€‚");
            if (!userLocation) return showMessage("âŒ GPSæƒ…å ±ã‚’å–å¾—ä¸­ã§ã™ã€‚");
            document.getElementById('confirmModal').style.display = 'flex';
        });

        function executeLineSend() {
            document.getElementById('confirmModal').style.display = 'none';
            const msg = `ã€æ•‘åŠ©è¦è«‹ã€‘Japan SOSã‚¢ãƒ—ãƒªã‚ˆã‚Šç¾åœ¨åœ°ã‚’å…±æœ‰ã—ã¾ã—ãŸã€‚åŠ©ã‘ã¦ãã ã•ã„ï¼š\n${userLocation}`;
            window.location.href = `line://msg/text/?${encodeURIComponent(msg)}`;
        }

        function showMessage(txt) {
            const msgDiv = document.createElement('div');
            msgDiv.style = "position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:rgba(255,59,48,0.9); color:white; padding:12px 25px; border-radius:50px; z-index:9999; font-size:0.9rem; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);";
            msgDiv.textContent = txt;
            document.body.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 4000);
        }

        function playSiren() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            oscillator.type = 'square';
            oscillator.connect(gain);
            gain.connect(audioCtx.destination);
            oscillator.start();
            let high = true;
            sirenInterval = setInterval(() => {
                oscillator.frequency.exponentialRampToValueAtTime(high ? 960 : 480, audioCtx.currentTime + 0.1);
                high = !high;
            }, 500);
        }

        document.getElementById('sosBtn').addEventListener('click', function() {
            if (!isPlaying) {
                isPlaying = true; playSiren(); this.textContent = "STOP"; this.classList.add('active');
            } else {
                isPlaying = false; if(oscillator) oscillator.stop(); clearInterval(sirenInterval); this.textContent = "è­¦å ±"; this.classList.remove('active');
            }
        });

        document.getElementById('voiceBtn').addEventListener('click', () => {
            let s = new SpeechSynthesisUtterance("ç·Šæ€¥äº‹æ…‹ã§ã™ï¼åŠ©ã‘ã¦ãã ã•ã„ï¼");
            s.lang = 'ja-JP'; window.speechSynthesis.speak(s);
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => { if (reg.active) setStatusReady(); });
            navigator.serviceWorker.addEventListener('message', e => { if (e.data.type === 'CACHE_SUCCESS') setStatusReady(); });
        }

        function setStatusReady() {
            document.getElementById('status-text').style.display = 'none';
            document.getElementById('status-icon').style.display = 'inline';
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('installBtn').style.display = 'none';
            }
        });
    </script>
</body>
</html>

